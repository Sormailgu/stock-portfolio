<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Stock Portfolio Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .sortable-header:hover {
            color: #14b8a6; /* teal-500 */
        }
        .sort-asc::after {
            content: ' ▲';
            font-size: 0.8em;
        }
        .sort-desc::after {
            content: ' ▼';
            font-size: 0.8em;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-slate-900">Stock Portfolio Dashboard</h1>
            <p class="text-slate-500 mt-2">An interactive overview of your US and HK stock holdings.</p>
        </header>

        <section id="filters" class="mb-8 flex flex-wrap gap-2">
             <p class="w-full text-lg font-semibold text-slate-700 mb-2">This section allows you to filter your entire dashboard view. Select a market to focus on just those assets, or view all of them together. All charts and tables below will update based on your selection.</p>
            <button data-filter="All" class="filter-btn bg-teal-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-teal-600 transition-all">All Markets</button>
            <button data-filter="US" class="filter-btn bg-white text-slate-700 py-2 px-4 rounded-lg shadow-md hover:bg-slate-100 transition-all">US Market</button>
            <button data-filter="HK" class="filter-btn bg-white text-slate-700 py-2 px-4 rounded-lg shadow-md hover:bg-slate-100 transition-all">HK Market</button>
        </section>

        <section id="kpi-cards" class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
             <div class="md:col-span-3">
                 <p class="text-lg font-semibold text-slate-700 mb-2">Here is a high-level summary of your portfolio's financial health based on your current filter. It shows the total current value of your holdings, your initial investment, and your overall profit or loss.</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                <h3 class="text-slate-500 font-medium">Total Market Value</h3>
                <p id="total-market-value" class="text-3xl font-bold text-slate-900 mt-2">$0.00</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                <h3 class="text-slate-500 font-medium">Total Cost</h3>
                <p id="total-cost" class="text-3xl font-bold text-slate-900 mt-2">$0.00</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                <h3 class="text-slate-500 font-medium">Unrealized P/L</h3>
                <p id="total-pl" class="text-3xl font-bold text-slate-900 mt-2">$0.00</p>
            </div>
        </section>

        <section id="visualizations" class="mb-8 grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                <h3 class="text-xl font-bold text-slate-900 mb-1">Portfolio Composition</h3>
                <p class="text-slate-500 mb-4">This chart shows the breakdown of your portfolio by the market value of each stock. Hover over a slice to see its value.</p>
                <div class="chart-container">
                    <canvas id="compositionChart"></canvas>
                </div>
            </div>
            <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                <h3 class="text-xl font-bold text-slate-900 mb-1">Market Performance (Cost vs. Value)</h3>
                <p class="text-slate-500 mb-4">This chart compares the total cost of your investments against their current market value, grouped by market.</p>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </section>

        <section id="holdings-table" class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
             <h3 class="text-xl font-bold text-slate-900 mb-1">Detailed Holdings</h3>
             <p class="text-slate-500 mb-4">This table provides a detailed look at each of your holdings. Click on any column header with an arrow icon to sort the table by that value. The data shown reflects the market filter selected above.</p>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b-2 border-slate-200">
                            <th class="p-3 sortable-header" data-sort="symbol">Symbol</th>
                            <th class="p-3">Company</th>
                            <th class="p-3 text-right sortable-header" data-sort="shares">Shares</th>
                            <th class="p-3 text-right sortable-header" data-sort="avgCost">Avg. Cost</th>
                            <th class="p-3 text-right sortable-header" data-sort="marketValue">Market Value</th>
                            <th class="p-3 text-right sortable-header" data-sort="pl">Unrealized P/L</th>
                            <th class="p-3 text-right sortable-header" data-sort="plPercent">Unrealized P/L %</th>
                        </tr>
                    </thead>
                    <tbody id="portfolio-body">
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        async function fetchStockData() {
            const response = await fetch('/api/stocks');
            return await response.json();
        }

        let currentFilter = 'All';
        let currentSort = { key: 'marketValue', order: 'desc' };
        let compositionChart, performanceChart;

        function formatCurrency(value, currency = 'USD') {
            const options = { style: 'currency', currency, minimumFractionDigits: 2 };
            return new Intl.NumberFormat('en-US', options).format(value);
        }

        function updateKpiCards(data) {
            const totalMarketValue = data.reduce((sum, stock) => sum + stock.marketValueUSD, 0);
            const totalCost = data.reduce((sum, stock) => sum + stock.totalCostUSD, 0);
            const totalPl = totalMarketValue - totalCost;

            document.getElementById('total-market-value').textContent = formatCurrency(totalMarketValue);
            document.getElementById('total-cost').textContent = formatCurrency(totalCost);
            const plElement = document.getElementById('total-pl');
            plElement.textContent = formatCurrency(totalPl);
            plElement.style.color = totalPl >= 0 ? '#10b981' : '#ef4444'; // green-500 or red-500
        }

        function renderTable(data) {
            const tbody = document.getElementById('portfolio-body');
            tbody.innerHTML = '';
            
            data.sort((a, b) => {
                let valA = a[currentSort.key];
                let valB = b[currentSort.key];
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                return currentSort.order === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });

            data.forEach(stock => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-100 hover:bg-slate-50';

                const plColor = stock.pl >= 0 ? 'text-green-600' : 'text-red-600';

                row.innerHTML = `
                    <td class="p-3 font-medium">${stock.symbol} <span class="text-xs text-slate-400">${stock.market}</span></td>
                    <td class="p-3 text-slate-600">${stock.company}</td>
                    <td class="p-3 text-right">${stock.shares.toLocaleString()}</td>
                    <td class="p-3 text-right">${formatCurrency(stock.avgCost, stock.currency)}</td>
                    <td class="p-3 text-right font-semibold">${formatCurrency(stock.marketValue, stock.currency)}</td>
                    <td class="p-3 text-right ${plColor}">${formatCurrency(stock.pl, stock.currency)}</td>
                    <td class="p-3 text-right ${plColor}">${stock.plPercent.toFixed(2)}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDashboard() {
            fetchStockData().then(data => {
                const filteredData = currentFilter === 'All' ? data : data.filter(stock => stock.market === currentFilter);
                updateKpiCards(filteredData);
                renderTable(filteredData);
                updateCompositionChart(filteredData);
                updatePerformanceChart(filteredData);
            });
        }

        document.querySelectorAll('.filter-btn').forEach(button => {
            button.addEventListener('click', () => {
                currentFilter = button.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('bg-teal-500', 'text-white');
                    btn.classList.add('bg-white', 'text-slate-700');
                });
                button.classList.add('bg-teal-500', 'text-white');
                button.classList.remove('bg-white', 'text-slate-700');
                updateDashboard();
            });
        });

        window.onload = function() {
            updateDashboard();
        };

    </script>
</body>
</html>